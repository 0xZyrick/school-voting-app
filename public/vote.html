<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vote for Your School - Braintree Arena</title>
  <link rel="icon" href="./assets/Assets/logo.jpg" type="image/jpg">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.paystack.co/v1/inline.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
    import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';

    const BACKEND_URL = "https://school-voting-backend-5ika.onrender.com";

    function VotingPage() {
      const [schools, setSchools] = useState([]);
      const [searchTerm, setSearchTerm] = useState('');
      const [expandedSchool, setExpandedSchool] = useState(null);
      const [showVoteModal, setShowVoteModal] = useState(false);
      const [selectedVote, setSelectedVote] = useState(null);
      const [voteCount, setVoteCount] = useState(0);
      const [isLoading, setIsLoading] = useState(true);

      useEffect(() => {
        fetchSchools();
      }, []);

      const fetchSchools = async () => {
        try {
          const response = await fetch(`${BACKEND_URL}/api/schools`);
          const data = await response.json();
          
          // Sort alphabetically by school name
          const sorted = data.sort((a, b) => a.schoolName.localeCompare(b.schoolName));
          setSchools(sorted);
          setIsLoading(false);
        } catch (error) {
          console.error('Error fetching schools:', error);
          setIsLoading(false);
        }
      };

      const filteredSchools = schools.filter(school =>
        school.schoolName.toLowerCase().includes(searchTerm.toLowerCase()) ||
        school.lga.toLowerCase().includes(searchTerm.toLowerCase())
      );

      // Vote options: 1, 5, 20, 50, 100, 1000 votes (from your original code)
      const voteOptions = [1, 5, 20, 50, 100, 1000];

      const openVoteModal = (schoolId, activity) => {
        setSelectedVote({ schoolId, activity });
        setVoteCount(0);
        setShowVoteModal(true);
      };

      const closeVoteModal = () => {
        setShowVoteModal(false);
        setSelectedVote(null);
        setVoteCount(0);
      };

      const proceedToPayment = () => {
        if (voteCount === 0) {
          alert('Please select vote amount');
          return;
        }

        const amountInKobo = voteCount * 10000; // â‚¦100 per vote Ã— 100 kobo

        const handler = window.PaystackPop.setup({
          key: 'pk_live_615ebb0069ee567a13a7fd38571a79c25e3a0a7e', // âš ï¸ Your Paystack key
          email: 'braintreearena@gmail.com',
          amount: amountInKobo,
          currency: 'NGN',
          ref: 'VOTE-' + Math.floor((Math.random() * 1000000000) + 1),
          callback: function(response) {
            verifyPayment(response.reference);
          },
          onClose: function() {
            alert('Payment cancelled');
          }
        });

        handler.openIframe();
      };

      const verifyPayment = async (reference) => {
        try {
          const response = await fetch(`${BACKEND_URL}/api/payment/verify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              reference: reference,
              schoolId: selectedVote.schoolId,
              activity: selectedVote.activity,
              votes: voteCount
            })
          });

          const data = await response.json();
          
          if (response.ok) {
            alert('âœ… Vote successful!');
            closeVoteModal();
            fetchSchools(); // Refresh to show updated votes
          } else {
            alert('âŒ Failed: ' + data.message);
          }
        } catch (error) {
          alert('âŒ Error verifying payment');
          console.error(error);
        }
      };

      const getTotalVotes = (school) => {
        return Object.values(school.votes || {}).reduce((sum, votes) => sum + votes, 0);
      };

      return React.createElement('div', { className: 'min-h-screen bg-gradient-to-br from-green-50 via-white to-orange-50' },
        // Navigation
        React.createElement('nav', { className: 'bg-white shadow-md' },
          React.createElement('div', { className: 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8' },
            React.createElement('div', { className: 'flex justify-between items-center h-20' },
              React.createElement('div', { className: 'flex items-center space-x-3' },
                React.createElement('div', { className: 'w-12 h-12 rounded-full flex items-center justify-center' },
                  React.createElement('img', 
                  { 
                    src: './assets/Assets/logo.jpg',
                    alt:'logo',
                    className: 'text-white text-2xl font-bold' 
                    })
                ),
                React.createElement('div', null,
                  React.createElement('span', { className: 'font-bold text-xl text-green-800' }, 'Braintree Arena'),
                  React.createElement('p', { className: 'text-xs text-gray-500' }, 'Voting Portal')
                )
              ),
              React.createElement('button', {
                onClick: () => window.location.href = './arena.html',
                className: 'flex items-center space-x-2 text-gray-600 hover:text-green-600 transition'
              },
                React.createElement('span', null, 'â† Back to Home')
              )
            )
          )
        ),

        // Vote Modal
        showVoteModal && React.createElement('div', { className: 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4' },
          React.createElement('div', { className: 'bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl' },
            React.createElement('div', { className: 'flex justify-between items-center mb-6' },
              React.createElement('h3', { className: 'text-2xl font-bold text-gray-900' }, 'Select Vote Amount'),
              React.createElement('button', {
                onClick: closeVoteModal,
                className: 'text-gray-400 hover:text-gray-600 text-3xl leading-none'
              }, 'Ã—')
            ),

            React.createElement('p', { className: 'text-gray-600 mb-6' },
              'Voting for: ',
              React.createElement('span', { className: 'font-bold text-green-600' }, selectedVote?.activity)
            ),

            React.createElement('div', { className: 'grid grid-cols-3 gap-3 mb-6' },
              voteOptions.map(option =>
                React.createElement('button', {
                  key: option,
                  onClick: () => setVoteCount(option),
                  className: `py-4 rounded-xl font-bold text-lg transition transform hover:scale-105 ${
                    voteCount === option
                      ? 'bg-orange-500 text-white shadow-lg'
                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`
                }, option)
              )
            ),

            React.createElement('button', {
              onClick: () => setVoteCount(0),
              className: 'w-full mb-6 py-3 border-2 border-gray-300 text-gray-700 rounded-xl font-semibold hover:bg-gray-50 transition'
            }, 'Clear Selection'),

            React.createElement('div', { className: 'bg-green-50 border-2 border-green-200 rounded-xl p-6 mb-6 text-center' },
              React.createElement('p', { className: 'text-sm text-gray-600 mb-2' }, 'Total Amount'),
              React.createElement('p', { className: 'text-4xl font-bold text-green-600' }, 'â‚¦' + (voteCount * 100)),
              React.createElement('p', { className: 'text-sm text-gray-500 mt-2' }, voteCount + ' votes Ã— â‚¦100')
            ),

            React.createElement('button', {
              onClick: proceedToPayment,
              disabled: voteCount === 0,
              className: 'w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed'
            }, 'Proceed to Payment')
          )
        ),

        // Main Content
        React.createElement('main', { className: 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12' },
          // Header
          React.createElement('div', { className: 'text-center mb-12' },
            React.createElement('h1', { className: 'text-4xl md:text-5xl font-bold text-gray-900 mb-4' }, 'Vote for Your Favorite School'),
            React.createElement('p', { className: 'text-xl text-gray-600 mb-2' }, 'Support your school and help them win'),
            React.createElement('div', { className: 'inline-block bg-yellow-50 border-2 border-yellow-200 px-4 py-2 rounded-full' },
              React.createElement('p', { className: 'text-yellow-800 font-semibold' },
                'Each vote costs ',
                React.createElement('span', { className: 'text-md font-bold' }, 'â‚¦100')
              )
            )
          ),

          // Search Bar
          React.createElement('div', { className: 'max-w-2xl mx-auto mb-12' },
            React.createElement('div', { className: 'relative' },
              React.createElement('span', { className: 'absolute left-6 top-1/2 transform -translate-y-1/2 text-gray-400 text-2xl' }, 'ðŸ”'),
              React.createElement('input', {
                type: 'text',
                placeholder: 'Search schools by name or LGA...',
                value: searchTerm,
                onChange: (e) => setSearchTerm(e.target.value),
                className: 'w-full pl-16 pr-6 py-5 text-lg border-2 border-gray-200 rounded-full focus:border-green-500 focus:outline-none shadow-lg'
              })
            )
          ),

          // Schools List
          isLoading ? (
            React.createElement('div', { className: 'text-center py-20' },
              React.createElement('div', { className: 'inline-block w-16 h-16 border-4 border-green-600 border-t-transparent rounded-full animate-spin' }),
              React.createElement('p', { className: 'mt-4 text-gray-600' }, 'Loading schools...')
            )
          ) : filteredSchools.length === 0 ? (
            React.createElement('div', { className: 'text-center py-20' },
              React.createElement('p', { className: 'text-xl text-gray-500' }, 'No schools found matching "' + searchTerm + '"')
            )
          ) : (
            React.createElement('div', { className: 'space-y-4' },
              filteredSchools.map((school) =>
                React.createElement(SchoolCard, {
                  key: school._id,
                  school: school,
                  isExpanded: expandedSchool === school._id,
                  onToggle: () => setExpandedSchool(expandedSchool === school._id ? null : school._id),
                  onVote: openVoteModal,
                  getTotalVotes: getTotalVotes
                })
              )
            )
          )
        ),

        // Footer
        React.createElement('footer', { className: 'bg-gray-900 text-white py-8 mt-20' },
          React.createElement('div', { className: 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center' },
            React.createElement('p', { className: 'text-gray-400' }, 'Â© 2024 Braintree Company. All rights reserved.')
          )
        )
      );
    }

    function SchoolCard({ school, isExpanded, onToggle, onVote, getTotalVotes }) {
      const totalVotes = getTotalVotes(school);

      return React.createElement('div', { className: 'bg-white rounded-2xl shadow-lg overflow-hidden hover:shadow-xl transition' },
        // School Header
        React.createElement('div', {
          onClick: onToggle,
          className: 'p-6 cursor-pointer hover:bg-gray-50 transition'
        },
          React.createElement('div', { className: 'flex justify-between items-center' },
            React.createElement('div', { className: 'flex-1' },
              React.createElement('h3', { className: 'text-2xl font-bold text-gray-900 mb-1' }, school.schoolName),
              React.createElement('p', { className: 'text-gray-500 flex items-center space-x-2' },
                React.createElement('span', null, school.lga + ', ' + school.state)
              )
            ),
            
            React.createElement('div', { className: 'flex items-center space-x-6' },
              React.createElement('div', { className: 'text-right' },
                React.createElement('div', { className: 'flex items-center space-x-2' },
                  React.createElement('span', { className: 'text-2xl' }, 'ðŸ“Š'),
                  React.createElement('span', { className: 'text-3xl font-bold text-green-600' }, totalVotes)
                ),
                React.createElement('p', { className: 'text-sm text-gray-500' }, 'total votes')
              ),
              
              React.createElement('div', { className: 'text-gray-400' },
                React.createElement('span', { className: 'text-2xl' }, isExpanded ? 'â–²' : 'â–¼')
              )
            )
          )
        ),

        // Activities Table
        isExpanded && React.createElement('div', { className: 'border-t border-gray-200 p-6 bg-gray-50' },
          React.createElement('div', { className: 'overflow-x-auto' },
            React.createElement('table', { className: 'w-full' },
              React.createElement('thead', null,
                React.createElement('tr', { className: 'border-b-2 border-gray-200' },
                  React.createElement('th', { className: 'text-left py-3 px-4 font-bold text-gray-700' }, 'Activity'),
                  React.createElement('th', { className: 'text-center py-3 px-4 font-bold text-gray-700' }, 'Current Votes'),
                  React.createElement('th', { className: 'text-center py-3 px-4 font-bold text-gray-700' }, 'Action')
                )
              ),
              React.createElement('tbody', null,
                Object.entries(school.votes || {}).map(([activity, votes]) =>
                  React.createElement('tr', { 
                    key: activity,
                    className: 'border-b border-gray-100 hover:bg-white transition'
                  },
                    React.createElement('td', { className: 'py-4 px-4 font-medium text-gray-800' }, activity),
                    React.createElement('td', { className: 'text-center py-4 px-4' },
                      React.createElement('span', { className: 'inline-block bg-green-100 text-green-700 px-4 py-2 rounded-full font-bold' }, votes)
                    ),
                    React.createElement('td', { className: 'text-center py-4 px-4' },
                      React.createElement('button', {
                        onClick: () => onVote(school._id, activity),
                        className: 'bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-2 rounded-full font-semibold hover:shadow-lg transform hover:scale-105 transition'
                      }, 'Vote Now')
                    )
                  )
                )
              )
            )
          )
        )
      );
    }

    // Render the app
    createRoot(document.getElementById('root')).render(React.createElement(VotingPage));
  </script>
</body>
</html>